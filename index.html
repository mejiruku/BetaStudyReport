<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StudyReport</title>
    <meta name="data-app-version" content="2.0.0.bata2">
    <link rel="stylesheet" href="./css/style.css?v=2.0.0.bata2">
    <link rel="manifest" href="./manifest.json?v=1.1.1">
    <link rel="icon" type="image/x-icon" href="./assets/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/apple-touch-icon-180x180.png">
</head>

<body>
    <!-- ======================================== -->
    <!-- Auth Guard Screen (未ログイン時のみ表示) -->
    <!-- ======================================== -->
    <div id="auth-guard-screen" class="auth-guard">
        <div class="auth-guard-content">
            <h1>📚 StudyReport</h1>
            <p>学習記録アプリ</p>
            <button class="auth-guard-btn" onclick="login()">ログインして始める</button>
        </div>
    </div>

    <!-- ======================================== -->
    <!-- Main App Container (ログイン後に表示) -->
    <!-- ======================================== -->
    <div id="app-container" class="app-container" style="display: none;">
        
        <!-- ヘッダー -->
        <header class="app-header">
            <div class="header-left">
                <h1>StudyReport</h1>
                <span id="save-status" class="save-status"></span>
            </div>
            <div class="header-right">
                <!-- ストップウォッチ/タイマーウィジェット -->
                <div class="stopwatch-widget" id="stopwatch-widget">
                    <button id="sw-mode-btn" class="sw-mode-btn" onclick="toggleTimerMode()" title="モード切替">⏱</button>
                    
                    <!-- 時間表示 (共通) -->
                    <span id="stopwatch-display" class="stopwatch-display">00:00:00</span>
                    
                    <!-- タイマー設定 (タイマーモード時のみ表示) -->
                    <div id="timer-input-area" class="timer-input-area" style="display: none;">
                        <input type="number" id="timer-minutes" placeholder="分" min="1" max="999">
                        <span>分</span>
                    </div>

                    <button id="sw-start-btn" class="sw-btn start" onclick="toggleTimerAction()" title="スタート">▶</button>
                    <button id="sw-reset-btn" class="sw-btn reset" onclick="resetTimerAction()" title="リセット">↻</button>
                </div>
                <div class="user-info">
                    <img id="user-icon" src="" alt="" class="user-icon" style="display: none;">
                    <span id="user-display" class="user-display" style="display: none;"></span>
                    <button id="header-settings-btn" class="header-settings-btn" onclick="openSettingsModal()" title="設定">⚙</button>
                </div>
            </div>
        </header>

        <!-- メインコンテンツ (タブ切り替え) -->
        <main class="app-main">
            
            <!-- Tab 1: 教材 (旧 Materials Tab) -->
            <div id="tab-materials" class="tab-content active">
                <div class="materials-container">
                    <div class="materials-header">
                        <h2>📚 教材一覧</h2>
                        <button class="add-material-btn" onclick="openMaterialModal()">＋ 教材を追加</button>
                    </div>
                    <div id="materials-list" class="materials-list">
                        <p class="empty-message">教材が登録されていません</p>
                    </div>
                </div>
            </div>

            <!-- Tab 2: タイムライン (新設) -->
            <div id="tab-timeline" class="tab-content">
                <div class="timeline-container">
                    <h2>🕒 タイムライン</h2>
                    <div id="timeline-list" class="timeline-list">
                        <!-- JSで動的生成 -->
                    </div>
                </div>
            </div>

            <!-- Tab 3: 日報 (旧 Home Tab) -->
            <div id="tab-report" class="tab-content">
                <div class="home-container">
                    <!-- 日報作成機能 -->
                    <section class="daily-report-section">
                        <div class="report-header">
                            <h3>📧 日報作成</h3>
                            <button class="auto-generate-btn" onclick="generateReportFromRecords()">🔄 今日の記録から自動生成</button>
                        </div>
                        
                        <div class="date-section">
                            <input type="date" id="report-date">
                        </div>

                        <!-- 既存の教科入力リスト（手動修正用） -->
                        <div id="subjects-container"></div>
                        
                        <div class="controls">
                            <button class="add-btn" onclick="addSubject()">＋ 教科を追加</button>
                            <button class="reset-btn" onclick="resetData()">リセット</button>
                        </div>

                        <!-- 全体の感想 -->
                        <div class="global-comment-section">
                            <label>全体の感想・コメント</label>
                            <textarea id="global-comment-text" placeholder="今日の総括や明日への意気込みなど" oninput="generateText()"></textarea>
                        </div>

                        <!-- 結果表示 -->
                        <div class="result-area">
                            <div class="total-display" id="screen-total">合計: 0時間 0分</div>
                            <button class="copy-btn" onclick="copyToClipboard()">コピーする</button>
                            <textarea id="output-text" readonly></textarea>
                        </div>
                        
                        <!-- バックアップ操作 -->
                        <div class="backup-controls">
                            <button class="export-btn" onclick="exportData()">バックアップ書き出し</button>
                            <button class="import-btn" onclick="document.getElementById('import-file').click()">読み込み</button>
                            <input type="file" id="import-file" style="display: none;" onchange="importData(this)" accept=".json,.rep">
                            <button class="log-btn" onclick="showSyncLog()">同期ログ</button>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Tab 4: 分析 (旧 Stats Tab) -->
            <div id="tab-stats" class="tab-content">
                <div class="stats-container">
                    <h2>📊 学習分析</h2>
                    <!-- Stats Detail Cards -->
                    <section class="stats-detail">
                        <div class="stats-detail-card">
                            <h4>今日の学習</h4>
                            <p id="stats-today-detail" class="stats-big-number">0分</p>
                        </div>
                        <div class="stats-detail-card">
                            <h4>今月の学習</h4>
                            <p id="stats-month-detail" class="stats-big-number">0時間</p>
                        </div>
                        <div class="stats-detail-card">
                            <h4>総学習時間</h4>
                            <p id="stats-total-detail" class="stats-big-number">0時間</p>
                        </div>
                    </section>
                    <!-- Weekly Chart -->
                    <section class="weekly-chart-section">
                        <h3>週間の学習推移</h3>
                        <div id="weekly-chart" class="weekly-chart"></div>
                        <div id="chart-legend" class="chart-legend"></div>
                    </section>
                </div>
            </div>

        </main>

        <!-- フッターナビゲーション -->
        <nav class="bottom-nav">
            <button class="nav-btn active" data-tab="materials" onclick="switchTab('materials')">
                <span class="nav-icon">📚</span>
                <span class="nav-label">教材</span>
            </button>
            <button class="nav-btn" data-tab="timeline" onclick="switchTab('timeline')">
                <span class="nav-icon">�</span>
                <span class="nav-label">タイムライン</span>
            </button>
            <button class="nav-btn" data-tab="report" onclick="switchTab('report')">
                <span class="nav-icon">�</span>
                <span class="nav-label">日報</span>
            </button>
            <button class="nav-btn" data-tab="stats" onclick="switchTab('stats')">
                <span class="nav-icon">📊</span>
                <span class="nav-label">分析</span>
            </button>
        </nav>
    </div>

    <!-- ======================================== -->
    <!-- モーダル群 -->
    <!-- ======================================== -->

    <!-- Custom Popup Modal -->
    <div id="popup-modal" class="popup-overlay">
        <div class="popup-content">
            <p id="popup-message"></p>
            <button id="popup-close-btn" class="popup-btn">OK</button>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirm-modal" class="popup-overlay">
        <div class="popup-content">
            <p id="confirm-message"></p>
            <div class="confirm-buttons">
                <button id="confirm-cancel-btn" class="popup-btn cancel">キャンセル</button>
                <button id="confirm-ok-btn" class="popup-btn">OK</button>
            </div>
        </div>
    </div>

    <!-- Sync Log Modal -->
    <div id="sync-log-modal" class="popup-overlay">
        <div class="popup-content log-modal-content">
            <h3 style="margin-top: 0; color: #006680;">操作ログ</h3>
            <div id="sync-log-list" class="sync-log-list"></div>
            <div class="confirm-buttons">
                <button id="sync-log-clear-btn" onclick="clearSyncLog()" class="popup-btn cancel">ログを全削除</button>
                <button id="sync-log-close-btn" onclick="closeSyncLogModal()" class="popup-btn">閉じる</button>
            </div>
        </div>
    </div>

    <!-- Export Options Modal -->
    <div id="export-modal" class="popup-overlay">
        <div class="popup-content">
            <p>書き出しオプションを選択してください</p>
            <div class="confirm-buttons" style="flex-direction: column; gap: 10px;">
                <button id="export-with-logs-btn" class="popup-btn" style="width: 100%;">ログを含めて書き出し</button>
                <button id="export-no-logs-btn" class="popup-btn" style="width: 100%; background-color: #4CAF50;">データのみ書き出し</button>
                <button id="export-cancel-btn" class="popup-btn cancel" style="width: 100%;">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="popup-overlay">
        <div class="popup-content login-modal-content">
            <h3 style="margin-top: 0; color: #006680;">ログイン</h3>
            <div id="login-method-select" class="login-method-section">
                <button id="google-login-btn" class="login-method-btn google" onclick="performGoogleLogin()">
                    <span class="login-icon">G</span>
                    Googleでログイン
                </button>
                <button id="email-login-btn" class="login-method-btn email" onclick="showEmailForm()">
                    <span class="login-icon">✉</span>
                    メール / パスワード
                </button>
            </div>
            <div id="email-login-form" class="email-login-form" style="display: none;">
                <div class="form-group">
                    <label for="login-email">メールアドレス</label>
                    <input type="email" id="login-email" placeholder="example@mail.com">
                </div>
                <div class="form-group">
                    <label for="login-password">パスワード</label>
                    <input type="password" id="login-password" placeholder="パスワード">
                </div>
                <div class="email-login-buttons">
                    <button id="email-signin-btn" class="popup-btn" onclick="performEmailSignIn()">ログイン</button>
                    <button id="email-signup-btn" class="popup-btn signup" onclick="performEmailSignUp()">新規登録</button>
                </div>
                <button id="back-to-methods-btn" class="back-link" onclick="showMethodSelect()">← 戻る</button>
            </div>
            <button onclick="closeLoginModal()" class="popup-btn cancel" style="margin-top: 15px; width: 100%;">キャンセル</button>
        </div>
    </div>

    <!-- 学習記録 Modal -->
    <div id="record-modal" class="popup-overlay">
        <div class="popup-content record-modal-content">
            <h3 style="margin-top: 0; color: #006680;">📝 学習を記録</h3>
            
            <!-- 教材選択 -->
            <div class="form-group">
                <label for="record-material">教材</label>
                <select id="record-material" class="record-select">
                    <option value="">教材を選択してください</option>
                </select>
            </div>

            <!-- 学習日時 -->
            <div class="form-group">
                <label for="record-datetime">学習日時</label>
                <input type="datetime-local" id="record-datetime">
            </div>

            <!-- 学習時間 -->
            <div class="form-group">
                <label>学習時間</label>
                <div class="time-inputs">
                    <select id="record-hours" class="time-h"></select> 時間
                    <select id="record-minutes" class="time-m"></select> 分
                </div>
            </div>

            <!-- 学習量 -->
            <div class="form-group">
                <label for="record-amount">学習量</label>
                <div class="amount-input-group">
                    <input type="number" id="record-amount" min="0" placeholder="0">
                    <span id="record-unit-label">ページ</span>
                </div>
            </div>

            <!-- 感想 -->
            <div class="form-group">
                <label for="record-comment">感想・メモ</label>
                <textarea id="record-comment" placeholder="今日やったこと..."></textarea>
            </div>

            <div class="confirm-buttons">
                <button onclick="closeRecordModal()" class="popup-btn cancel">キャンセル</button>
                <button onclick="saveStudyRecord()" class="popup-btn">保存</button>
            </div>
        </div>
    </div>

    <!-- 教材追加/編集 Modal -->
    <div id="material-modal" class="popup-overlay">
        <div class="popup-content material-modal-content">
            <h3 id="material-modal-title" style="margin-top: 0; color: #006680;">📚 教材を追加</h3>
            
            <!-- 教材名 -->
            <div class="form-group">
                <label for="material-title">教材名</label>
                <input type="text" id="material-title" placeholder="例: 英単語ターゲット1900">
            </div>

            <!-- カテゴリ -->
            <div class="form-group">
                <label for="material-category">カテゴリ</label>
                <select id="material-category">
                    <option value="english">英語</option>
                    <option value="math">数学</option>
                    <option value="japanese">国語</option>
                    <option value="science">理科</option>
                    <option value="social">社会</option>
                    <option value="other">その他</option>
                </select>
            </div>

            <!-- 単位 -->
            <div class="form-group">
                <label for="material-unit">単位</label>
                <select id="material-unit">
                    <option value="ページ">ページ</option>
                    <option value="問">問</option>
                    <option value="単語">単語</option>
                    <option value="PART">PART</option>
                    <option value="章">章</option>
                    <option value="回">回</option>
                </select>
            </div>

            <!-- 画像 -->
            <div class="form-group">
                <label>教材画像（任意）</label>
                <div class="image-upload-area">
                    <input type="file" id="material-image" accept="image/*" onchange="previewMaterialImage(this)">
                    <div id="material-image-preview" class="image-preview"></div>
                </div>
            </div>

            <input type="hidden" id="material-edit-id" value="">

            <div class="confirm-buttons">
                <button onclick="closeMaterialModal()" class="popup-btn cancel">キャンセル</button>
                <button onclick="saveMaterial()" class="popup-btn">保存</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Init Firebase -->
    <script src="./js/firebase-init.js?v=custom"></script>

    <!-- App Logic -->
    <script src="./js/script.js?v=2.0.0.bata2" async></script>
</body>

</html>